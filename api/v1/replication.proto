syntax = "proto3";

package nexusbase.api.v1;

import "google/protobuf/empty.proto";

option go_package = "github.com/INLOpen/nexusbase/api/v1;apiv1";

// ReplicationService defines the service for data replication between nodes.
service ReplicationService {
  // StreamWAL allows a follower to stream WAL entries from a leader.
  // The stream will block and wait for new entries if the follower is caught up.
  rpc StreamWAL(StreamWALRequest) returns (stream WALEntry) {}

  // GetLatestState returns the latest sequence number and WAL segment index from the leader.
  // This is used by a follower to determine its replication lag.
  rpc GetLatestState(google.protobuf.Empty) returns (LatestStateResponse) {}
 
  // GetSnapshot allows a follower to bootstrap by receiving a full snapshot of the database.
  rpc GetSnapshot(SnapshotRequest) returns (stream SnapshotChunk) {}
 
  // ReportProgress allows a follower to report its latest applied sequence number to the leader.
  // This is used for synchronous replication to unblock waiting client writes.
  rpc ReportProgress(ReportProgressRequest) returns (google.protobuf.Empty) {}

}

message ReportProgressRequest {
  // The sequence number that the follower has successfully applied.
  uint64 applied_sequence_number = 1;
}

message StreamWALRequest {
  // The sequence number from which the follower wants to start streaming.
  uint64 from_sequence_number = 1;
}

message LatestStateResponse {
  uint64 latest_sequence_number = 1;
  uint64 latest_wal_segment_index = 2;
}

message WALEntry {
  uint64 sequence_number = 1;
  uint64 wal_segment_index = 2; // Follower needs this for its own checkpointing

  oneof payload {
    PutEvent put_event = 3;
    DeleteEvent delete_event = 4;
    DeleteSeriesEvent delete_series_event = 5;
    DeleteRangeEvent delete_range_event = 6;
  }
}

message PutEvent {
  bytes key = 1;
  bytes value = 2; // Encoded FieldValues

  // The following fields are added to allow a follower to reconstruct its own
  // metadata (string/series stores) without needing to query the leader.
  string metric = 3;
  map<string, string> tags = 4;
  int64 timestamp = 5;
}

message DeleteEvent {
  bytes key = 1;
}

message DeleteSeriesEvent {
  bytes key_prefix = 1;
}

message DeleteRangeEvent {
  bytes key_prefix = 1;
  int64 start_ts = 2;
  int64 end_ts = 3;
}

message SnapshotRequest {
  // Can be extended later to request partial snapshots.
}

message SnapshotChunk {
  // Relative path within the snapshot directory.
  // e.g., "sst/000001.sst", "MANIFEST", "string_mapping.log"
  string file_path_relative = 1;
  bytes content = 2;
}